<!-- XMLBible.html
 - James Skon: original version April 2011
 - Bob Kasper: revised March 2021
 - Benjamin Leskey: revised March 2021
 - Mount Vernon Nazarene University
 -->
<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>XML Bible Demo - MVNU</title>
		<script type="text/javascript">
			function setup() {
				if (window.XMLHttpRequest) {
					// Modern browsers (IE7+, Chrome, Firefox, etc.)
					xmlhttp = new XMLHttpRequest();
				}
				else {
					// Ancient browsers (IE5-6)
					xmlhttp = new ActiveXObject("Microsoft.XMLHTTP");
				}

				// location of XML Bible files, must be on same web server
				// that hosts this web page to avoid Cross-Domain request restrictions
				biblePath = "/class/csc3004/XMLBible";

				// Map of human-readable version identifiers to server Bible names.
				bibles = {
					"kjv": "kjv",
					"web": "web",
				};
			}

			// Get the server path to the book XML for the specified bible version and book number.
			function getBookPath(version, book) {
				if(version in bibles) {
					return biblePath + "/" + bibles[version] + "_by_book/" + book + ".xml";
				}
				else {
					throw "no version";
				}
			}

			// Get the parsed book XML for the specified bible version and book number.
			function getBookDoc(version, book) {
				xmlhttp.open("GET", getBookPath(version, book), false);
				xmlhttp.send();
				return xmlhttp.responseXML;
			}

			function getResponse () {
				// Get input values from the form.
				var version = document.getElementById("version").value;
				var b = document.getElementById("book").value;
				var c = document.getElementById("chapter").value;
				var v = parseInt(document.getElementById("verse").value);
				var nv = parseInt(document.getElementById("versenum").value);

				xmlDoc = getBookDoc(version, b);

				try {
					// Reset the display.
					document.all.responseArea.innerHTML = " ";

					// Show the verses.
					for(const verse of getVerses(b, c, v, nv)) {
						document.all.responseArea.innerHTML += "<p>" + verse["text"] + "</p>";
					}
				}
				catch(error) {
					if (error == "no chapter") {
						document.all.responseArea.innerHTML += "<b><i>No such chapter " + c + "</i></b>";
					}
					else if (error == "no verse") {
						document.all.responseArea.innerHTML += "<b><i>No such verse " + v + "</i></b>";
					}
					else {
						document.all.responseArea.innerHTML += "<b><i>Internal error: " + error + "<i></b>";
					}
				}
			}

			function getNextSiblingOfTag(element, tag) {
				var next = element.nextSibling;
				while(next != null && next.nodeType != 1 && next.nodeName != tag) {
					next = next.nextSibling;
				}
				return next;
			}

			function getVerses(b, c, v, count) {
				var result = [];
				var book = xmlDoc.getElementsByTagName("book")[0];
				var chapter = book.getElementsByTagName("chapter")[c - 1];
				if (chapter == null)
					throw "no chapter";

				var verse = chapter.getElementsByTagName("verse")[v - 1]
				if (verse == null)
					throw "no verse";

				for(var i = 0; i < count; i++) {
					var verseDescriptor = {
						"b": parseInt(book.getAttribute("number").value),
						"c": parseInt(chapter.getAttribute("number").value),
						"v": parseInt(verse.getAttribute("number").value),
						"text": "",
					};

					for(const node of verse.childNodes) {
						verseDescriptor.text += getNodeString(node);
					}

					result.push(verseDescriptor);

					verse = getNextSiblingOfTag(verse, "verse");
					if(verse == null) {
						chapter = getNextSiblingOfTag(chapter, "chapter");
						if(chapter == null) {
							break;
						}
						else {
							verse = chapter.getElementsByTagName("verse")[0];
							if(verse == null) {
								break;
							}
						}
					}
				}

				return result;
			}

			function getNodeString(node) {
				var result = "";
				if (node.nodeType == 3) {
					// type 3: text node, just display
					result += node.nodeValue;
					result += " ";
				}
				else if (node.nodeType == 1) {
					// type 1: tag, parse it
					if (node.nodeName == "em") {
						result += "<i>";
						result += node.childNodes[0].nodeValue;
						result += "</i> ";
					}
					else if (node.nodeName == "STYLE") {
						result += '<span style="' + node.getAttribute("css") + '">';
						for (n=0; n < node.childNodes.length; n++) {
							var nodeStr = getNodeString(node.childNodes[n]);
							result += nodeStr;
						}
						result += "</span> ";
					}
					else if (node.nodeName == "strongs") {
						// Word with a Strong's reference.
						if (node.childNodes[0] != null) {
							// Show the word.
							result += node.childNodes[0].nodeValue;
						}

						if(document.getElementById("include_strongs").checked) {
							// Get and display the Strong's number.
							var number = 0;

							if(node.hasAttribute("hebrew")) {
								number = node.getAttribute("hebrew");
							}
							else if(node.hasAttribute("greek")) {
								number = node.getAttribute("greek");
							}
							else if(node.hasAttribute("number")) {
								number = node.getAttribute("number");
							}

							result += "<sub>" + number + "</sub>";
						}

						result += " ";
					}
				}
				return result;
			}
		</script>
	</head>

	<body onLoad="setup()">
		<form onsubmit="return false">
			<h1>Bible Search from XML files</h1>
			<table>
				<TR>
					<TD ALIGN=RIGHT VALIGN=TOP>Bible Version</TD>
					<TD ALIGN=LEFT VALIGN=TOP>
						<select name="version" id="version">
							<option value="kjv">King James Version
							<option value="web">World English Bible
						</select>
					</TD>
				</TR>
				<TR>
					<TD ALIGN=RIGHT VALIGN=TOP>Book Number</TD>
					<TD ALIGN=LEFT VALIGN=TOP><INPUT NAME="book" TYPE="text" MAXLENGTH=2  id=book></TD>
				</TR>
				<TR>
					<TD ALIGN=RIGHT VALIGN=TOP>Chapter</TD>
					<TD ALIGN=LEFT VALIGN=TOP><INPUT NAME="chapter" TYPE="text" MAXLENGTH=3  id=chapter></TD>
				</TR>
				<TR>
					<TD ALIGN=RIGHT VALIGN=TOP>Verse</TD>
					<TD ALIGN=LEFT VALIGN=TOP><INPUT NAME="verse" TYPE="text" MAXLENGTH=3 id=verse></TD>
				</TR>
				<TR>
					<TD ALIGN=RIGHT VALIGN=TOP>Number of Verses</TD>
					<TD ALIGN=LEFT VALIGN=TOP><INPUT NAME="versenum" TYPE="text" MAXLENGTH=3 id=versenum></TD>
				</TR>
				<TR>
					<TD ALIGN=RIGHT VALIGN=TOP>Include Strong's References</TD>
					<TD ALIGN=LEFT VALIGN=TOP><INPUT NAME="include_strongs" id=include_strongs type="checkbox"></TD>
				</TR>
			</table>
			<p>
				<input type="submit" onclick="javascript: getResponse()" name="submit" value="Submit" />
			</p>
		</form>
		<div id = "responseArea">
		</div>
	</body>
</html>
